!function(e,n){"use strict";e.module("wm.websocket",[]).service("WmSocket",["$rootScope","$q",function(t,s){function o(t,o){var r=this;r.options=e.extend({namespace:"app"},o),r.websocket=new n(t,r.options.protocols),r.deferred=s.defer(),r.websocket.addEventListener("open",r.deferred.resolve),r.websocket.addEventListener("error",r.deferred.reject),r.$$callbacks={}}var r=o.prototype;return r.$onOpen=function(e){this.websocket.addEventListener("open",function(n){e(n),t.$apply()})},r.$onClose=function(e){this.websocket.addEventListener("close",function(n){e(n),t.$apply()})},r.$send=function(t){var o=s.defer(),r=this;return o.promise.then(function(){r.websocket.send(e.toJson(t))}),n.OPEN===this.websocket.readyState?(o.resolve(),o.promise):(r.websocket.addEventListener("open",function e(){o.resolve(),r.websocket.removeEventListener("open",e)}),r.websocket.addEventListener("error",function e(n){o.reject(n),r.websocket.removeEventListener("error",e)}),o.promise)},r.$emit=function(e,n){var t=this;return t.$send({$channel:t.$$buildKey(e),$message:n})},r.$on=function(n,s){var o=this;o.$send({$subscribe:o.$$buildKey(n)});var r=function(r){var i=e.fromJson(r.data);i.$channel===o.$$buildKey(n)&&s(i.$message),t.$apply()};return o.websocket.addEventListener("message",r),o.$$addChannelListener(n,r),o},r.$off=function(n){var t=this;t.$send({$unsubscribe:t.$$buildKey(n)}).then(function(){var s=t.$$callbacks[n];e.isArray(s)&&e.forEach(s,function(e){t.websocket.removeEventListener("message",e)}),t.$$callbacks[n]=[]})},r.$$addChannelListener=function(n,t){return e.isArray(this.$$callbacks[n])||(this.$$callbacks[n]=[]),this.$$callbacks[n].push(t),this},r.$$buildKey=function(e){return this.options.namespace+":"+e},r.$subscribe=r.$listen,r.$unsubscribe=r.$off,o}])}(window.angular,window.WebSocket);